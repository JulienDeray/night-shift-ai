---
phase: 01-notification-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/config.ts
  - src/core/types.ts
  - tests/unit/config.test.ts
autonomous: true
requirements:
  - NTFY-01
  - NTFY-06
  - CONF-01
  - CONF-02

must_haves:
  truths:
    - "A nightshift.yaml with an ntfy block (topic, optional token, optional base_url) passes Zod validation and produces a typed NtfyConfig object"
    - "A nightshift.yaml without ntfy or code_agent blocks loads without error, producing undefined for those fields"
    - "A recurring task with notify: true in YAML loads as a boolean on RecurringTaskConfig"
    - "A code_agent block with repo_url (SSH), confluence_page_id, and category_schedule passes validation"
    - "A code_agent.category_schedule with a typo like 'munday' fails Zod validation"
    - "getDefaultConfigYaml() includes commented-out examples for ntfy and code_agent blocks"
  artifacts:
    - path: "src/core/config.ts"
      provides: "Zod schemas for ntfy, code_agent, category_schedule, and notify field on recurring tasks"
      contains: "NtfyConfigSchema"
    - path: "src/core/types.ts"
      provides: "NtfyConfig, CodeAgentConfig, CategoryScheduleConfig interfaces and updated RecurringTaskConfig/NightShiftConfig"
      contains: "NtfyConfig"
    - path: "tests/unit/config.test.ts"
      provides: "Unit tests for new config blocks"
      contains: "ntfy"
  key_links:
    - from: "src/core/config.ts"
      to: "src/core/types.ts"
      via: "mapConfig maps raw Zod output to typed interfaces"
      pattern: "ntfy.*topic"
    - from: "tests/unit/config.test.ts"
      to: "src/core/config.ts"
      via: "loadConfig with YAML containing ntfy/code_agent blocks"
      pattern: "loadConfig.*ntfy"
---

<objective>
Extend the nightshift.yaml config schema with ntfy notification settings, code_agent settings, and per-task notify opt-in.

Purpose: Provide the validated configuration plumbing that NtfyClient (Plan 02) and the orchestrator (Phase 2) will consume. All new blocks are optional so the daemon starts without them.

Output: Extended Zod schemas in config.ts, new TypeScript interfaces in types.ts, updated mapConfig(), updated getDefaultConfigYaml(), and unit tests proving all validation rules.
</objective>

<execution_context>
@/Users/julienderay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julienderay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-notification-foundation/01-CONTEXT.md
@.planning/phases/01-notification-foundation/01-RESEARCH.md
@src/core/config.ts
@src/core/types.ts
@tests/unit/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ntfy, code_agent, and notify schemas and types</name>
  <files>src/core/types.ts, src/core/config.ts</files>
  <action>
**In `src/core/types.ts`**, add the following interfaces BEFORE the `NightShiftConfig` interface:

```typescript
export interface NtfyConfig {
  topic: string;
  token?: string;
  baseUrl: string;
}

export interface CategoryScheduleConfig {
  monday?: string[];
  tuesday?: string[];
  wednesday?: string[];
  thursday?: string[];
  friday?: string[];
  saturday?: string[];
  sunday?: string[];
}

export interface CodeAgentConfig {
  repoUrl: string;
  confluencePageId: string;
  categorySchedule: CategoryScheduleConfig;
}
```

Add `notify?: boolean` to the `RecurringTaskConfig` interface.

Add `ntfy?: NtfyConfig` and `codeAgent?: CodeAgentConfig` to the `NightShiftConfig` interface.

**In `src/core/config.ts`**, add these Zod schemas BEFORE the `ConfigSchema`:

1. `CategoryScheduleSchema` — `z.object()` with all 7 day names as optional `z.array(z.string().min(1))`, with `.strict()` to reject typos.

2. `NtfyConfigSchema` — `z.object({ topic: z.string().min(1), token: z.string().optional(), base_url: z.string().default("https://ntfy.sh") }).optional()`

3. `CodeAgentSchema` — `z.object({ repo_url: z.string().regex(/^git@[a-zA-Z0-9._-]+:[a-zA-Z0-9._\/-]+\.git$/, "repo_url must be an SSH git URL (git@host:org/repo.git)"), confluence_page_id: z.string().min(1), category_schedule: CategoryScheduleSchema }).optional()`

4. Add `notify: z.boolean().optional()` to `RecurringTaskSchema`.

5. Add `ntfy: NtfyConfigSchema` and `code_agent: CodeAgentSchema` to `ConfigSchema`.

**Update `mapConfig()`** to map the new fields:
- `ntfy`: if `raw.ntfy` is defined, map to `{ topic: raw.ntfy.topic, token: raw.ntfy.token, baseUrl: raw.ntfy.base_url }` — otherwise `undefined`
- `codeAgent`: if `raw.code_agent` is defined, map to `{ repoUrl: raw.code_agent.repo_url, confluencePageId: raw.code_agent.confluence_page_id, categorySchedule: raw.code_agent.category_schedule }` (category_schedule keys are already camelCase-friendly since they are day names)
- `notify`: add `notify: r.notify` to the recurring task mapping

**Update `getDefaultConfigYaml()`** to include commented-out examples for both blocks. Insert after the `one_off_defaults` block:
```
# ntfy:
#   topic: night-shift
#   token: tk_abc123        # optional
#   base_url: https://ntfy.sh  # optional, defaults to ntfy.sh

# code_agent:
#   repo_url: git@gitlab.com:team/repo.git
#   confluence_page_id: "123456"
#   category_schedule:
#     monday: [tests]
#     tuesday: [refactoring]
#     wednesday: [docs]
#     thursday: [error_handling]
#     friday: [cleanup]
```

CRITICAL: Follow Zod v4 patterns exactly — use `z.object(...).strict()` for CategoryScheduleSchema (NOT `z.record` with enum key, which requires all keys present in Zod v4). The ntfy `message` field name mapping is NOT relevant here (that is NtfyClient concern in Plan 02). Ensure `NtfyConfigSchema` and `CodeAgentSchema` are `.optional()` on the outer object so daemon starts without them.
  </action>
  <verify>
    <automated>cd /Users/julienderay/code/night-shift && npx tsc --noEmit</automated>
    <manual>Check that types.ts has NtfyConfig, CodeAgentConfig, CategoryScheduleConfig interfaces and config.ts has corresponding Zod schemas</manual>
  </verify>
  <done>TypeScript compiles with no errors. NightShiftConfig includes optional ntfy and codeAgent fields. RecurringTaskConfig includes optional notify boolean. getDefaultConfigYaml() includes commented-out ntfy and code_agent examples.</done>
</task>

<task type="auto">
  <name>Task 2: Add config validation unit tests for new blocks</name>
  <files>tests/unit/config.test.ts</files>
  <action>
Add new test cases to the existing `describe("config", ...)` block in `tests/unit/config.test.ts`. Follow the existing test pattern (write YAML string to tmpDir, call `loadConfig(tmpDir)`, assert on the result).

Add these test cases:

1. **"loads config with ntfy block"** — YAML with `ntfy: { topic: "night-shift", token: "tk_abc", base_url: "https://custom.ntfy.sh" }`. Assert `config.ntfy` is defined, `config.ntfy.topic === "night-shift"`, `config.ntfy.token === "tk_abc"`, `config.ntfy.baseUrl === "https://custom.ntfy.sh"`.

2. **"applies default base_url for ntfy"** — YAML with `ntfy: { topic: "test" }` (no base_url). Assert `config.ntfy.baseUrl === "https://ntfy.sh"`.

3. **"loads config without ntfy block"** — Minimal YAML (`workspace: ./w`). Assert `config.ntfy` is `undefined`.

4. **"loads config with code_agent block"** — YAML with full code_agent block including repo_url (SSH), confluence_page_id, and category_schedule with monday: [tests], tuesday: [refactoring]. Assert all fields mapped correctly: `config.codeAgent.repoUrl`, `config.codeAgent.confluencePageId`, `config.codeAgent.categorySchedule.monday` equals `["tests"]`.

5. **"rejects invalid repo_url (not SSH)"** — YAML with `code_agent: { repo_url: "https://gitlab.com/team/repo.git", confluence_page_id: "123", category_schedule: { monday: [tests] } }`. Assert `loadConfig` rejects/throws with "Invalid config".

6. **"rejects unknown day name in category_schedule"** — YAML with `code_agent: { repo_url: "git@gitlab.com:team/repo.git", confluence_page_id: "123", category_schedule: { munday: [tests] } }`. Assert `loadConfig` rejects/throws (Zod strict mode rejects unknown keys).

7. **"loads recurring task with notify flag"** — YAML with a recurring task that includes `notify: true`. Assert `config.recurring[0].notify === true`.

8. **"notify defaults to undefined when not specified"** — YAML with a recurring task without notify. Assert `config.recurring[0].notify` is `undefined`.

9. **"loads config without code_agent block"** — Minimal YAML. Assert `config.codeAgent` is `undefined`.

10. **"getDefaultConfigYaml includes ntfy and code_agent examples"** — Call `getDefaultConfigYaml()` and assert the returned string contains "ntfy:", "topic:", "code_agent:", "repo_url:", "category_schedule:".

Use the existing pattern: `await fs.writeFile(path.join(tmpDir, "nightshift.yaml"), yaml)` then `const config = await loadConfig(tmpDir)`. For rejection tests use `await expect(loadConfig(tmpDir)).rejects.toThrow(...)`.
  </action>
  <verify>
    <automated>cd /Users/julienderay/code/night-shift && npx vitest run tests/unit/config.test.ts</automated>
  </verify>
  <done>All existing config tests still pass. All new tests pass: ntfy block loads with and without defaults, code_agent block loads with valid SSH URL, invalid SSH URL is rejected, unknown day name is rejected, notify flag loads on recurring tasks, getDefaultConfigYaml includes commented-out examples.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npx vitest run tests/unit/config.test.ts` — all tests pass (existing + new)
3. `npx vitest run` — full test suite passes (no regressions)
</verification>

<success_criteria>
- NightShiftConfig has optional ntfy and codeAgent fields with correct types
- RecurringTaskConfig has optional notify boolean
- Zod rejects typos in category_schedule day names
- Zod rejects non-SSH repo_url values
- Daemon loads fine with or without ntfy/code_agent blocks
- getDefaultConfigYaml() shows commented-out examples
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-notification-foundation/01-01-SUMMARY.md`
</output>
