---
phase: 02-orchestrator-hooks
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/core/types.ts
  - src/daemon/scheduler.ts
  - tests/unit/scheduler.test.ts
autonomous: true
requirements: [CONF-03]

must_haves:
  truths:
    - "NightShiftTask carries notify and category fields propagated from config"
    - "Daemon resolves today's improvement category from the code_agent day-of-week schedule"
    - "Category is frozen at task creation time, not re-resolved later"
    - "Tasks created without code_agent config have category undefined"
  artifacts:
    - path: "src/core/types.ts"
      provides: "notify and category fields on NightShiftTask"
      contains: "notify?: boolean"
    - path: "src/daemon/scheduler.ts"
      provides: "resolveCategory helper and propagation in createTask"
      contains: "resolveCategory"
    - path: "tests/unit/scheduler.test.ts"
      provides: "Tests for category resolution and notify/category propagation"
      contains: "resolveCategory"
  key_links:
    - from: "src/daemon/scheduler.ts"
      to: "src/core/types.ts"
      via: "NightShiftTask.category and NightShiftTask.notify fields"
      pattern: "category.*resolveCategory"
---

<objective>
Extend NightShiftTask with `notify` and `category` fields, implement `resolveCategory()` to map today's weekday to a category from `CategoryScheduleConfig`, and propagate both fields in `Scheduler.createTask()`.

Purpose: The orchestrator only receives `NightShiftTask` objects -- it has no access to `RecurringTaskConfig`. Without these fields on the task, notification hooks (Plan 02) cannot know whether to send notifications or what category to include. Category must be resolved once at dispatch time, not at completion time.

Output: Extended type, resolveCategory helper, updated createTask, and unit tests proving all behaviors.
</objective>

<execution_context>
@/Users/julienderay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julienderay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-orchestrator-hooks/02-RESEARCH.md
@.planning/phases/01-notification-foundation/01-01-SUMMARY.md
@src/core/types.ts
@src/daemon/scheduler.ts
@tests/unit/scheduler.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Add failing tests for category resolution and task field propagation</name>
  <files>tests/unit/scheduler.test.ts</files>
  <action>
Add a new `describe("category resolution and notify propagation")` block inside the existing top-level `describe("Scheduler")`. Tests to add:

1. **resolveCategory returns correct category for each weekday** -- Create a `CategoryScheduleConfig` with known values per day. For each of the 7 days (0=Sunday through 6=Saturday), mock `Date` so `new Date().getDay()` returns that value. Call `evaluateSchedules()` on a scheduler with a due recurring task that has `notify: true`, and assert `task.category` matches the expected value from the schedule.

2. **resolveCategory returns undefined when day has no entry** -- Configure schedule with only monday set. Mock Date to return Wednesday (3). Assert `task.category` is `undefined`.

3. **resolveCategory returns undefined when no codeAgent config** -- No `codeAgent` on the config at all. Assert `task.category` is `undefined`.

4. **resolveCategory takes first element from array** -- Configure `monday: ["tests", "docs"]`. Mock Date to Monday (1). Assert `task.category` is `"tests"` (first element).

5. **resolveCategory returns undefined for empty array** -- Configure `monday: []`. Mock Date to Monday (1). Assert `task.category` is `undefined`.

6. **task.notify is propagated from RecurringTaskConfig.notify** -- Add a recurring task with `notify: true`. Assert the created `NightShiftTask` has `notify: true`.

7. **task.notify defaults to undefined when not set** -- Add a recurring task without `notify`. Assert the created `NightShiftTask` has `notify` as `undefined`.

Use `vi.useFakeTimers()` and `vi.setSystemTime(new Date("2026-01-05T02:00:00Z"))` (a Monday) to control the day. Use `vi.useRealTimers()` in afterEach. The scheduler needs beads disabled and file-queue mocking (existing pattern in the test file -- write to tmpDir queue).

Run tests: `npm test -- tests/unit/scheduler.test.ts -t "category"` -- they MUST fail (RED).

Commit: `test(02-01): add failing tests for category resolution and notify propagation`
  </action>
  <verify>
    <automated>npm test -- tests/unit/scheduler.test.ts -t "category" 2>&1 | tail -5</automated>
    <manual>All new tests fail because NightShiftTask lacks notify/category fields and scheduler does not resolve them</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>7 new test cases exist, all failing with expected errors about missing fields or wrong values</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement type extension, resolveCategory, and createTask propagation</name>
  <files>src/core/types.ts, src/daemon/scheduler.ts</files>
  <action>
**In `src/core/types.ts`:**
Add two optional fields to the `NightShiftTask` interface:
```typescript
notify?: boolean;
category?: string;
```
Place them after the `recurringName` field for logical grouping.

**In `src/daemon/scheduler.ts`:**

1. Import `CategoryScheduleConfig` from types (add to the existing type import line).

2. Add a module-level pure function `resolveCategory`:
```typescript
const DAYS: (keyof CategoryScheduleConfig)[] = [
  "sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday",
];

export function resolveCategory(
  schedule: CategoryScheduleConfig | undefined,
): string | undefined {
  if (!schedule) return undefined;
  const todayKey = DAYS[new Date().getDay()];
  const categories = schedule[todayKey];
  return categories?.length ? categories[0] : undefined;
}
```

Export it so tests can import it directly if needed, but the primary consumer is `createTask()`.

3. Update `createTask()` to propagate both fields on the `NightShiftTask` object:
```typescript
const task: NightShiftTask = {
  // ... existing fields ...
  recurringName: recurring.name,
  notify: recurring.notify,
  category: resolveCategory(this.config.codeAgent?.categorySchedule),
};
```

The `notify` field comes directly from `RecurringTaskConfig.notify` (already typed as `boolean | undefined`).
The `category` field comes from `resolveCategory()` using the `codeAgent.categorySchedule` from the top-level config.

Do NOT add any logging for category resolution -- keep it minimal. The orchestrator's notification helpers (Plan 02) will log the category when sending notifications.

Run all tests: `npm test -- tests/unit/scheduler.test.ts` -- all must pass (GREEN).

Commit: `feat(02-01): extend NightShiftTask with notify/category, implement resolveCategory`
  </action>
  <verify>
    <automated>npm test -- tests/unit/scheduler.test.ts --reporter=verbose 2>&1 | tail -20</automated>
    <manual>All scheduler tests pass including the 7 new category/notify tests</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>NightShiftTask has notify and category fields, resolveCategory correctly maps weekday to category, createTask propagates both, all tests green</done>
</task>

</tasks>

<verification>
- `npm test -- tests/unit/scheduler.test.ts --reporter=verbose` -- all tests pass
- `npm run typecheck` -- no type errors
- `npm test` -- full suite green, no regressions
</verification>

<success_criteria>
- NightShiftTask interface has `notify?: boolean` and `category?: string`
- resolveCategory maps each weekday correctly, handles missing days, empty arrays, and absent config
- Scheduler.createTask propagates both fields from config to task
- All existing scheduler tests still pass
- 7 new tests specifically covering CONF-03 behaviors
</success_criteria>

<output>
After completion, create `.planning/phases/02-orchestrator-hooks/02-01-SUMMARY.md`
</output>
